const fs = require("fs");
const path = require("path");
const os = require("os");
const { PROVIDER_TYPE_CLAUDE_OFFICIAL, PROVIDER_TYPE_THIRD_PARTY } = require('./constants');

/**
 * Ë¥¶Âè∑ÁÆ°ÁêÜÂô®
 * Ë¥üË¥£Â§ÑÁêÜClaudeË¥¶Âè∑ÁöÑËÆ§ËØÅ„ÄÅÂàáÊç¢ÂíåÁÆ°ÁêÜ
 */
class AccountManager {
    constructor(configManager) {
        this.configManager = configManager;
    }

    /**
     * Ëé∑ÂèñÊ¥ªÂä®Ë¥¶Âè∑‰ø°ÊÅØ
     */
    getActiveAccountInfo() {
        try {
            console.log(`[DEBUG] [Claude Interceptor] üîç Getting active account info...`);
            const settingsData = this.configManager.loadSettingsFromStore();
            if (settingsData) {
                console.log(`[DEBUG] [Claude Interceptor] üìÅ Settings data loaded successfully`);
                console.log(`[DEBUG] [Claude Interceptor] üìã Active service provider ID: ${settingsData.activeServiceProviderId}`);
                
                const activeResult = this.configManager.getCurrentActiveAccountFromSettings(settingsData);
                if (activeResult) {
                    const { provider, account } = activeResult;
                    console.log(`[DEBUG] [Claude Interceptor] üîç Found active account - Provider: ${provider.type}, Account: ${account.emailAddress || account.name}`);

                    if (provider.type === PROVIDER_TYPE_CLAUDE_OFFICIAL) {
                        const accountInfo = {
                            type: PROVIDER_TYPE_CLAUDE_OFFICIAL,
                            emailAddress: account.emailAddress,
                            authorization: account.authorization
                        };
                        
                        console.log(`[DEBUG] [Claude Interceptor] üîë Claude account token status: ${account.authorization ? 'Has token' : 'No token'}`);
                        if (account.authorization) {
                            console.log(`[DEBUG] [Claude Interceptor] üîë Token preview: ${account.authorization.substring(0, 20)}...`);
                        }
                        
                        // Â¶ÇÊûúÊñ∞ÂàáÊç¢ÁöÑË¥¶Âè∑Ê≤°ÊúâtokenÔºåÂ∞ùËØï‰∏ªÂä®Ëé∑Âèñ
                        if (!account.authorization && account.emailAddress) {
                            console.log(`[DEBUG] [Claude Interceptor] üîÑ New account without token, attempting to retrieve: ${account.emailAddress}`);
                            this.attemptToRetrieveTokenForAccount(account.emailAddress);
                        }
                        
                        return accountInfo;
                    } else {
                        console.log(`[DEBUG] [Claude Interceptor] üî∂ Third-party account: ${account.name}`);
                        return {
                            type: PROVIDER_TYPE_THIRD_PARTY,
                            name: account.name,
                            apiKey: account.apiKey,
                            baseUrl: account.baseUrl
                        };
                    }
                }
            }
            console.log('[DEBUG] [Claude Interceptor] ‚ö†Ô∏è No available account found');
            return null;
        } catch (error) {
            console.warn('[DEBUG] [Claude Interceptor] ‚ùå Unable to get account config:', error.message);
            return null;
        }
    }

    /**
     * Â∞ùËØï‰∏∫Ë¥¶Âè∑Ëé∑Âèñtoken
     * ÈÄöËøáÊ£ÄÊü•Claude CLIÁöÑÈÖçÁΩÆÊñá‰ª∂Êù•Ëé∑ÂèñÂ∑≤ÊúâÁöÑtoken
     */
    attemptToRetrieveTokenForAccount(emailAddress) {
        try {
            const os = require('os');
            const path = require('path');
            
            // Claude CLIÈÖçÁΩÆÊñá‰ª∂Ë∑ØÂæÑ
            const claudeConfigPath = path.join(os.homedir(), '.anthropic', 'claude-cli', 'config.json');
            
            if (fs.existsSync(claudeConfigPath)) {
                const configContent = fs.readFileSync(claudeConfigPath, 'utf-8');
                const config = JSON.parse(configContent);
                
                // Êü•ÊâæÂåπÈÖçÁöÑË¥¶Âè∑
                if (config.account && config.account.email === emailAddress && config.account.session_key) {
                    console.log(`[SILENT] [Claude Interceptor] Found existing token for account: ${emailAddress}`);
                    
                    // ÊûÑÂª∫authorization header
                    const authorization = `Bearer ${config.account.session_key}`;
                    
                    // Êõ¥Êñ∞ÈÖçÁΩÆ
                    this.updateAuthorizationInConfig(authorization);
                    
                    return authorization;
                }
            }
        } catch (error) {
            console.warn(`[SILENT] [Claude Interceptor] Failed to retrieve token for account ${emailAddress}:`, error.message);
        }
        return null;
    }

    /**
     * Êõ¥Êñ∞ÈÖçÁΩÆ‰∏≠ÁöÑauthorization
     */
    updateAuthorizationInConfig(authorization) {
        try {
            console.log(`[DEBUG] [Claude Interceptor] üîÑ Updating authorization in config...`);
            console.log(`[DEBUG] [Claude Interceptor] üîë Authorization preview: ${authorization.substring(0, 30)}...`);
            
            const accountInfo = this.getActiveAccountInfo();
            console.log(`[DEBUG] [Claude Interceptor] üìã Current account info:`, accountInfo);
            
            // Ê£ÄÊü•ÂΩìÂâçË¥¶Âè∑ÁöÑauthorizationÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞
            if (!accountInfo?.authorization || accountInfo.authorization !== authorization) {
                console.log(`[DEBUG] [Claude Interceptor] üîÑ Authorization needs update`);
                
                const settingsData = this.configManager.loadSettingsFromStore();
                if (settingsData) {
                    console.log(`[DEBUG] [Claude Interceptor] üìÅ Settings loaded for authorization update`);
                    
                    // È¶ñÂÖàÊ£ÄÊü•Ëøô‰∏™authorizationÊòØÂê¶Â∑≤Ë¢´ÂÖ∂‰ªñClaudeË¥¶Âè∑‰ΩøÁî®
                    const existingAccount = this.findClaudeAccountByAuthorization(settingsData, authorization);
                    
                    if (existingAccount) {
                        // Â¶ÇÊûúÂ∑≤Â≠òÂú®ËØ•authorizationÁöÑË¥¶Âè∑ÔºåÂàáÊç¢Âà∞ËØ•Ë¥¶Âè∑
                        console.log(`[DEBUG] [Claude Interceptor] ‚úÖ Found existing account for authorization: ${existingAccount.emailAddress}`);
                        this.switchToExistingAccount(settingsData, existingAccount.emailAddress);
                        return;
                    }

                    // Â¶ÇÊûúÂΩìÂâçÊúâË¥¶Âè∑ÈÖçÁΩÆÔºåÊõ¥Êñ∞ÂÖ∂authorization
                    if (accountInfo?.emailAddress) {
                        console.log(`[DEBUG] [Claude Interceptor] üíæ Updating authorization for account: ${accountInfo.emailAddress}`);
                        this.updateClaudeAccountAuthorization(settingsData, accountInfo.emailAddress, authorization);
                        const saveResult = this.configManager.saveSettingsToStore(settingsData);
                        console.log(`[DEBUG] [Claude Interceptor] üíæ Save result: ${saveResult}`);
                        console.log('[DEBUG] [Claude Interceptor] ‚úÖ Authorization saved to config file');
                        
                        // Ëß¶ÂèëtokenÊõ¥Êñ∞ÈÄöÁü•ÔºåÁî®‰∫éÈöêËóè‰ºöËØùÁöÑtokenÈ™åËØÅ
                        this.notifyTokenUpdate(accountInfo.emailAddress, authorization);
                    } else {
                        console.log(`[DEBUG] [Claude Interceptor] üîç No current account email, identifying from authorization...`);
                        // Â∞ùËØï‰ªéAPIËØ∑Ê±Ç‰∏≠ËØÜÂà´Ë¥¶Âè∑‰ø°ÊÅØ
                        this.identifyAccountFromAuthorization(authorization);
                    }
                }
            } else {
                console.log(`[DEBUG] [Claude Interceptor] ‚úÖ Authorization already up to date`);
            }
        } catch (error) {
            console.error('[DEBUG] [Claude Interceptor] ‚ùå Failed to save authorization:', error.message);
        }
    }

    /**
     * ÈÄöÁü•tokenÊõ¥Êñ∞
     * Áî®‰∫éÈÄöÁü•Êâ©Â±ïtokenÂ∑≤ÊàêÂäüËé∑Âèñ
     */
    notifyTokenUpdate(emailAddress, authorization) {
        try {
            const os = require('os');
            const path = require('path');
            
            // ÂàõÂª∫tokenÊõ¥Êñ∞ÈÄöÁü•Êñá‰ª∂
            const tempDir = path.join(os.tmpdir(), 'cc-copilot');
            if (!fs.existsSync(tempDir)) {
                fs.mkdirSync(tempDir, { recursive: true });
            }
            
            const tokenFile = path.join(tempDir, `token_${Date.now()}.json`);
            const tokenData = {
                emailAddress,
                authorization,
                timestamp: Date.now(),
                type: 'token_update'
            };
            
            fs.writeFileSync(tokenFile, JSON.stringify(tokenData));
            console.log(`[SILENT] [Claude Interceptor] Token update notification created: ${tokenFile}`);
        } catch (error) {
            console.warn('[SILENT] [Claude Interceptor] Failed to create token notification:', error.message);
        }
    }

    /**
     * ÂàáÊç¢Âà∞Â∑≤Â≠òÂú®ÁöÑË¥¶Âè∑
     */
    switchToExistingAccount(settingsData, emailAddress) {
        try {
            const serviceProviders = settingsData.serviceProviders || [];
            const claudeProvider = serviceProviders.find(p => p.type === PROVIDER_TYPE_CLAUDE_OFFICIAL);
            
            if (claudeProvider) {
                claudeProvider.activeAccountId = emailAddress;
                settingsData.activeServiceProviderId = claudeProvider.id;
                this.configManager.saveSettingsToStore(settingsData);
                
                console.log(`[TERMINAL] [Claude Interceptor] Switched to account: ${emailAddress}`);
            }
        } catch (error) {
            console.error('[SILENT] [Claude Interceptor] Failed to switch account:', error.message);
        }
    }

    /**
     * ‰ªéauthorization tokenËØÜÂà´Ë¥¶Âè∑‰ø°ÊÅØ
     */
    async identifyAccountFromAuthorization(authorization) {
        try {
            // ÈÄöËøáÂèëÈÄÅAPIËØ∑Ê±ÇËé∑ÂèñË¥¶Âè∑‰ø°ÊÅØ
            const userInfo = await this.fetchUserInfoFromAPI(authorization);
            if (userInfo && userInfo.email) {
                console.log(`[SILENT] [Claude Interceptor] Identified account from token: ${userInfo.email}`);
                
                // ÂàõÂª∫ÊàñÊõ¥Êñ∞Ë¥¶Âè∑‰ø°ÊÅØ
                const account = {
                    accountUuid: userInfo.id || '',
                    emailAddress: userInfo.email,
                    organizationUuid: userInfo.organization_id || '',
                    organizationRole: userInfo.organization_role || 'member',
                    workspaceRole: userInfo.workspace_role || null,
                    organizationName: userInfo.organization_name || 'Unknown',
                    authorization: authorization
                };

                // ‰øùÂ≠òÂà∞ÈÖçÁΩÆ
                const settingsData = this.configManager.loadSettingsFromStore();
                if (settingsData) {
                    await this.addOrUpdateClaudeAccount(settingsData, account);
                    this.configManager.saveSettingsToStore(settingsData);
                    
                    // ÂêåÊó∂‰øùÂ≠òÂà∞Êâ©Â±ïÁöÑÂÖ®Â±ÄÂ≠òÂÇ®‰∏≠
                    await this.saveAccountToExtensionStorage(account);
                }
            }
        } catch (error) {
            console.warn('[SILENT] [Claude Interceptor] Failed to identify account from authorization:', error.message);
        }
    }

    /**
     * ÈÄöËøáAPIËØ∑Ê±ÇËé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
     */
    async fetchUserInfoFromAPI(authorization) {
        try {
            const response = await fetch('https://api.anthropic.com/v1/account', {
                method: 'GET',
                headers: {
                    'authorization': authorization,
                    'content-type': 'application/json'
                }
            });

            if (response.ok) {
                return await response.json();
            } else if (response.status === 401) {
                console.warn('[SILENT] [Claude Interceptor] Authorization token expired or invalid');
                this.handleTokenExpired(authorization);
                return null;
            }
        } catch (error) {
            console.warn('[SILENT] [Claude Interceptor] Failed to fetch user info:', error.message);
        }
        return null;
    }

    /**
     * Â§ÑÁêÜtokenËøáÊúü
     */
    handleTokenExpired(expiredAuthorization) {
        try {
            const settingsData = this.configManager.loadSettingsFromStore();
            if (settingsData) {
                // Êü•Êâæ‰ΩøÁî®ËØ•tokenÁöÑË¥¶Âè∑
                const account = this.findClaudeAccountByAuthorization(settingsData, expiredAuthorization);
                if (account) {
                    console.warn(`[TERMINAL] [Claude Interceptor] Token expired for account: ${account.emailAddress}`);
                    // Ê∏ÖÈô§ËøáÊúüÁöÑtoken
                    account.authorization = undefined;
                    this.updateClaudeAccountAuthorization(settingsData, account.emailAddress, undefined);
                    this.configManager.saveSettingsToStore(settingsData);
                    
                    // Ëß¶ÂèëÈáçÊñ∞ÁôªÂΩïÊèêÁ§∫
                    this.promptRelogin(account.emailAddress);
                }
            }
        } catch (error) {
            console.error('[SILENT] [Claude Interceptor] Failed to handle token expiration:', error.message);
        }
    }

    /**
     * ÊèêÁ§∫Áî®Êà∑ÈáçÊñ∞ÁôªÂΩï
     */
    promptRelogin(emailAddress) {
        console.log(`[TERMINAL] [Claude Interceptor] Account ${emailAddress} needs to re-login. Token has expired.`);
    }

    /**
     * Ê∑ªÂä†ÊàñÊõ¥Êñ∞ClaudeË¥¶Âè∑
     */
    async addOrUpdateClaudeAccount(settingsData, account) {
        const serviceProviders = settingsData.serviceProviders || [];
        let claudeProvider = serviceProviders.find(p => p.type === PROVIDER_TYPE_CLAUDE_OFFICIAL);

        if (!claudeProvider) {
            claudeProvider = {
                id: 'claude_official',
                type: 'claude_official',
                name: 'Claude Official',
                accounts: [],
                activeAccountId: '',
                useProxy: true
            };
            serviceProviders.push(claudeProvider);
        }

        const accounts = claudeProvider.accounts;
        const existingIndex = accounts.findIndex(acc => acc.emailAddress === account.emailAddress);

        if (existingIndex >= 0) {
            // Êõ¥Êñ∞Áé∞ÊúâË¥¶Âè∑
            accounts[existingIndex] = { ...accounts[existingIndex], ...account };
        } else {
            // Ê∑ªÂä†Êñ∞Ë¥¶Âè∑
            accounts.push(account);
        }

        // ËÆæÁΩÆ‰∏∫Ê¥ªÂä®Ë¥¶Âè∑
        claudeProvider.activeAccountId = account.emailAddress;
        settingsData.activeServiceProviderId = claudeProvider.id;
        settingsData.serviceProviders = serviceProviders;
    }

    /**
     * ‰øùÂ≠òË¥¶Âè∑Âà∞Êâ©Â±ïÁöÑÂÖ®Â±ÄÂ≠òÂÇ®
     */
    async saveAccountToExtensionStorage(account) {
        try {
            console.log(`[SILENT] [Claude Interceptor] Account ready for extension storage: ${account.emailAddress}`);
            
            const tempDir = path.join(os.tmpdir(), 'cc-copilot');
            if (!fs.existsSync(tempDir)) {
                fs.mkdirSync(tempDir, { recursive: true });
            }
            
            const accountFile = path.join(tempDir, `account_${Date.now()}.json`);
            fs.writeFileSync(accountFile, JSON.stringify(account));
            console.log(`[SILENT] [Claude Interceptor] Account saved to temp file: ${accountFile}`);
        } catch (error) {
            console.warn('[SILENT] [Claude Interceptor] Failed to save account to temp storage:', error.message);
        }
    }

    /**
     * Ê†πÊçÆauthorizationÂÄºÊü•ÊâæClaudeË¥¶Âè∑
     */
    findClaudeAccountByAuthorization(settingsData, authorization) {
        try {
            const serviceProviders = settingsData.serviceProviders || [];
            const claudeProvider = serviceProviders.find(p => p.type === PROVIDER_TYPE_CLAUDE_OFFICIAL);

            if (!claudeProvider) return null;

            return claudeProvider.accounts.find(acc => acc.authorization === authorization) || null;
        } catch (error) {
            console.warn('[SILENT] [Claude Interceptor] Failed to find account:', error.message);
            return null;
        }
    }

    /**
     * Êõ¥Êñ∞ClaudeË¥¶Âè∑ÁöÑauthorizationÂÄº
     */
    updateClaudeAccountAuthorization(settingsData, emailAddress, authorization) {
        try {
            const serviceProviders = settingsData.serviceProviders || [];
            const claudeProvider = serviceProviders.find(p => p.type === PROVIDER_TYPE_CLAUDE_OFFICIAL);

            if (!claudeProvider) return false;

            const account = claudeProvider.accounts.find(acc => acc.emailAddress === emailAddress);
            if (account) {
                account.authorization = authorization;
                return true;
            }

            return false;
        } catch (error) {
            console.error('[SILENT] [Claude Interceptor] Failed to update authorization:', error.message);
            return false;
        }
    }
}

module.exports = AccountManager;